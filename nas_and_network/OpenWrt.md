# 网络

## 路由

> 为不同网段中的设备相互连接而需要的中转，例如 `192.168.3.1` -> `192.168.50.1`。（如果有 nat，是不能自上而下访问的）

路由表有以下形式（可以使用 `route` 去查看设备的路由表）：

1. 直连路由表：插入网线自动产生，不需要任何操作。
2. 静态路由表：需要手动添加，根据需求去配置。
3. 动态路由表：根据算法协议自动生成。

```bash
# 目的地址        网关（下一跳）    子网掩码          标识符               接口（从路由器的哪一个接口发送）
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
default         192.168.50.1    0.0.0.0         UG    0      0        0 eth0
192.168.3.0     *               255.255.255.0   U     0      0        0 br-lan
192.168.50.0    *               255.255.255.0   U     0      0        0 eth0
```

* 标识符 `U` 表示这条路由是活动的，`G` 表示下一跳的地址是一个网关，如果是一个未知地址，那么则会发给 `192.168.50.1`，并且子网掩码表示它是任意的。
* 第二条是从路由器 `lan` 口发送，这时是不需要网关的，所以它的网关是 `*`（0.0.0.0）。
* 如果目的地址是 `192.168.50.0` 这个网段，则是直接从 `wan` 口发送，也不需要网关。

例如，添加一条静态路由：

```bash
rotue add -net 192.168.5.0 netmask 255.255.255.0 gw 192.168.3.1 dev eth0
```

## 防火墙

> 防火墙夹在 lan 口与 wan 口之间，将外部网络和内部网络分开。

* `lan => wan`：这是内网中设备允许发往下一跳的设置
* `wan => Reject`：外网中的设备是不允许通过 wan 口连接内部网络的设备。
* **入站数据**、**出站数据**指路由器本身。
   1. 入站指的是 lan 口连接的设备都可以访问路由器（这会导致连接的设备无法访问路由器）
   2. 出站指的是路由器自身可以访问连接的设备（这会导致 DHCP 无法分配参数）
   3. 转发指的是 lan 口下的子网段可以经过转发访问 lan 口下的其它网段（这会导致网络之间隔离）

### 端口转发（DNAT）

> 在 wan 入站数据关闭的情况下，这是我们就需要设置**端口转发**。当我们访问子网络的 wan 口时，其将数据转发到 LAN（即 DNAT，目标地址转换）。

端口转发是将内网的设备端口转发到 `wan` 的端口，以备外部网络可以访问。如果不开启 nat 回环，只能从外部访问，只能是单向访问。

其中，**端口映射**是 SNAT，它是向公网发起连接时，将内部端口映射到外部

### 通信规则

> 例如 `Allow-DHCP-Renew` 就是 WAN 口给 DHCP 放行。

例如我们想不同的网段之间通信，比如在 `192.168.50.100` 想直接访问 `192.168.3.0` 这个网段的设备，其中口，主路由中静态地址默认是没有该网段的，我们要添加该网段。

1. 在主路由（例如：`192.168.50.1`）中添加静态路由，部分路由器也可以手动添加

   ```bash
    route add -net 192.168.3.0/24 -gw 192.168.1.3 br-lan
   ```

2. 这里在子路由的通信规则中设置。同样，源区域是 `wan`，目标区域是 `lan`（同时目标地址的防火墙也要放行）
